<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kioscos Jose Arteta</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="tu-logo.png">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@21.2.7/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@21.2.7/build/js/intlTelInput.min.js"></script>
    
    
    <style>

    
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    :root {
        --olive: #556B2F;
        --olive-light: #6b843d;
        --olive-soft: #f4f7ed;
        --slate: #1e293b;
    }

    body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        color: var(--slate);
        overflow-x: hidden; /* Evita scroll horizontal */
    }

    /* CORRECCI√ìN DE CAMPOS: Espaciado y Dimensiones */
    input, select, textarea {
        background-color: white !important;
        border: 1.5px solid #e2e8f0 !important;
        border-radius: 16px !important;
        padding: 0.8rem 1.2rem !important;
        margin-bottom: 4px; /* Espacio m√≠nimo para evitar contacto */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        width: 100%;
        box-sizing: border-box; /* Crucial para que el padding no aumente el ancho real */
    }

/* campo de numero de celular ajuste de centrado */
#c_tel { padding-left: 50px !important; }

    /* Espacio extra entre labels e inputs */
    label {
        display: block;
        margin-bottom: 6px;
        margin-top: 4px;
    }

    input:focus, select:focus, textarea:focus {
        border-color: var(--olive) !important;
        box-shadow: 0 0 0 4px rgba(85, 107, 47, 0.1) !important;
        transform: translateY(-1px);
    }

    /* Navegaci√≥n */
    .tab-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
        color: #94a3b8;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-radius: 20px;
        width: 58px;
        height: 58px;
    }

    .tab-btn.active {
        color: var(--olive);
        background: var(--olive-soft);
        transform: translateY(-8px);
    }

    /* Contenedores con animaciones suaves */
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 28px;
        box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.04);
        margin-bottom: 1.5rem; /* Evita que las tarjetas se toquen */
    }

    .app-section { display: none; }
    .active-section { display: block; animation: slideUp 0.5s ease-out; }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .btn-primary {
        background: var(--olive);
        color: white;
        border-radius: 18px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s;
        box-shadow: 0 10px 15px -3px rgba(85, 107, 47, 0.3);
    }
</style>
</head>
<body class="pb-32">

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md p-5 border-b border-gray-100 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="bg-olive p-2.5 rounded-2xl shadow-lg rotate-3">
                <img src="img/icono-pagina.png" alt="Logo" class="w-12 h-12 object-contain">
            </div>
            <div>
    <h1 class="text-lg font-black text-slate-800 uppercase tracking-widest leading-none mb-1">
        Kioscos Jose Arteta
    </h1>
    
    <p class="text-xs font-extrabold text-slate-400 leading-none">
        ARQUITECTURA NATURAL & <span class="text-olive">CONSTRUCCI√ìN T√âCNICA</span>
    </p>
</div>
        </div>
        <div class="bg-slate-50 px-4 py-2 rounded-2xl text-right">
            <span class="block text-[15px] font-bold text-slate-400 uppercase">Presupuesto</span>
            <div id="topTotal" class="text-xl font-black text-slate-900">$ 0</div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-6">

        <section id="sec-cliente" class="app-section active-section">
            <div class="glass-card p-6 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="w-1.5 h-6 bg-olive rounded-full"></div>
                    <h2 class="font-black text-slate-800 uppercase text-sm tracking-wider">Identificaci√≥n del Proyecto</h2>
                </div>

                <div class="grid grid-cols-1 gap-5">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 ml-3 uppercase">Nombre del Cliente</label>
                        <input type="text" id="c_nombre" placeholder="Ej: Juan P√©rez">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">

                       <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 ml-3 uppercase">Tel√©fono</label>
                        <input type="tel" id="c_tel" class="w-full" placeholder="300...">
                      </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 ml-3 uppercase">Correo</label>
                            <input type="email" id="c_email" placeholder="cliente@mail.com">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 ml-3 uppercase">Ubicaci√≥n de la Obra</label>
                        <input type="text" id="c_obra" placeholder="Ciudad, Barrio o Finca">
                    </div>

              <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-[2rem]">
    
    <div class="space-y-1">
        <label class="text-[10px] font-black text-olive ml-2 uppercase">Tipo de Documento</label>
        <select id="c_tipo" class="font-bold" onchange="toggleFacturaField()">
            <option value="COTIZACI√ìN">COTIZACI√ìN</option>
            <option value="FACTURA">FACTURA</option>
        </select>
    </div>
    
                <div class="space-y-1">
        <label class="text-[10px] font-black text-olive ml-2 uppercase">
            <span id="label-tiempo">Garant√≠a (D√≠as)</span>
        </label>
        <input type="number" id="c_garantia" value="0" class="text-center font-bold">
    </div>
    
    

    <div id="contenedor-num-factura" class="col-span-2 space-y-1 hidden">
        <label class="text-[10px] font-black text-slate-400 ml-2 uppercase">N√∫mero de Factura</label>
        <input type="text" id="c_num_factura" placeholder="Ej: 001" class="font-bold border-olive">
    </div>
</div>
                </div>

               <div id="anticipoSection" class="bg-olive/5 border border-olive/10 rounded-[2.5rem] p-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i data-lucide="banknote" class="text-olive"></i>
                            <div>
                                <p class="text-sm font-black text-slate-700 uppercase">Gesti√≥n de Anticipo</p>
                                <p class="text-[10px] text-slate-400 font-bold">Requerido para compra de insumos</p>
                            </div>
                        </div>
                        <input type="checkbox" id="chk_anticipo" class="w-6 h-6 accent-olive" onchange="toggleAnticipo()">
                    </div>
                    <div id="panel_anticipo" class="hidden mt-5 pt-5 border-t border-olive/10">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-slate-400 ml-2 uppercase">Porcentaje (%)</label>
                                <input type="number" id="val_anticipo_pct" value="0" oninput="calcular()">
                            </div>
                            <div class="text-right">
                                <label class="text-[10px] font-bold text-slate-400 mr-2 uppercase">Valor Sugerido</label>
                                <div id="monto_anticipo_final" class="text-xl font-black text-olive">$ 0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-mo" class="app-section">
            <div class="flex justify-between items-end mb-4 px-2">
                <div>
                    <h2 class="font-black text-slate-800 text-lg uppercase leading-none">Servicios</h2>
                    <p class="text-xs text-slate-400 font-bold">Mano de obra t√©cnica</p>
                </div>
                <div id="sub_mo" class="text-olive font-black text-xl">$ 0</div>
            </div>
            <div id="cont-mo" class="space-y-4"></div>
            <button onclick="addItem('MO')" class="btn-primary w-full py-5 mt-6 flex items-center justify-center gap-3">
                <i data-lucide="plus-circle"></i> Agregar Servicio
            </button>
        </section>

        <section id="sec-mat" class="app-section">
            <div class="flex justify-between items-end mb-4 px-2">
                <div>
                    <h2 class="font-black text-slate-800 text-lg uppercase leading-none">Insumos</h2>
                    <p class="text-xs text-slate-400 font-bold">Materiales de construcci√≥n</p>
                </div>
                <div id="sub_mat" class="text-slate-600 font-black text-xl">$ 0</div>
            </div>
            <div id="cont-mat" class="space-y-4"></div>
            <button onclick="addItem('MAT')" class="btn-primary !bg-slate-800 w-full py-5 mt-6 flex items-center justify-center gap-3">
                <i data-lucide="box"></i> Agregar Material
            </button>
        </section>

        <section id="sec-fotos" class="app-section">
            <h2 class="font-black text-slate-800 uppercase tracking-widest text-sm mb-6">Evidencia Visual</h2>
            <div id="cont-fotos" class="grid grid-cols-1 gap-6 mb-8"></div>
            
            <label class="glass-card w-full py-16 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 cursor-pointer hover:bg-white transition-all">
                <input type="file" class="hidden" multiple accept="image/*" onchange="handlePhotos(this)">
                <div class="bg-olive/10 p-5 rounded-full mb-4">
                    <i data-lucide="camera" class="w-10 h-10 text-olive"></i>
                </div>
                <span class="text-xs font-black uppercase text-slate-500 tracking-widest">Subir fotos de la obra</span>
            </label>
        </section>

        <section id="sec-pdf" class="app-section">
            <div class="glass-card p-8 text-center space-y-8">
                <div>
                    <h3 class="font-black text-2xl text-slate-800">An√°lisis del Proyecto</h3>
                    <p class="text-slate-400 text-sm font-medium">Distribuci√≥n de costos estimada</p>
                </div>

                <div class="relative h-64 w-full flex justify-center">
                    <canvas id="statsChart"></canvas>
                </div>

                <div class="p-6 bg-slate-50 rounded-[2.5rem]">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Inversi√≥n Total</span>
                    <div id="finalTotal" class="text-5xl font-black text-slate-900 my-2">$ 0</div>
                    <p id="statsSummary" class="text-xs font-bold text-olive uppercase"></p>
                </div>

                <button onclick="generarPDF()" class="btn-primary w-full py-6 text-lg flex items-center justify-center gap-4">
                    <i data-lucide="file-down"></i> Generar Documento PDF
                
                </button>

<div class="glass-card p-8 text-center space-y-8">
      

       
            
            <div class="grid grid-cols-2 gap-3">

         <button onclick="enviarWhatsApp()" class="bg-[#25D366] text-white rounded-2xl py-4 font-bold text-sm uppercase flex items-center justify-center gap-3 shadow-lg shadow-green-200">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="w-10 h-10" alt="WhatsApp">
    <span>WhatsApp</span>
</button>

    


                <button onclick="enviarEmail()" class="bg-slate-800 text-white rounded-2xl py-4 font-bold text-xs uppercase flex items-center justify-center gap-2 shadow-lg shadow-slate-200">
                    <i data-lucide="mail"></i> Correo
                </button>
            </div>
        </div>
    </div>





            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-2xl border-t border-slate-100 px-6 py-4 pb-8 flex justify-between items-center z-[100]">
        <button onclick="nav('cliente', this)" class="tab-btn active"><i data-lucide="user-circle"></i></button>
        <button onclick="nav('mo', this)" class="tab-btn"><i data-lucide="hammer"></i></button>
        <button onclick="nav('mat', this)" class="tab-btn"><i data-lucide="package"></i></button>
        <button onclick="nav('fotos', this)" class="tab-btn"><i data-lucide="images"></i></button>
        <button onclick="nav('pdf', this)" class="tab-btn"><i data-lucide="pie-chart"></i></button>
    </nav>

    <script>

// Agrega esto al inicio de tu secci√≥n de scripts
let LOGO_BASE64 = ""; 

// Funci√≥n para convertir tu imagen a un formato que el PDF entienda (Base64)
const imgLogo = new Image();
imgLogo.crossOrigin = "Anonymous";
imgLogo.src = 'https://lh3.googleusercontent.com/d/10kzjBUJdYomKRw_yIApoDVHL8ZTCoQaR';
imgLogo.onload = function() {
    const canvas = document.createElement("canvas");
    canvas.width = imgLogo.width;
    canvas.height = imgLogo.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(imgLogo, 0, 0);
    LOGO_BASE64 = canvas.toDataURL("image/png");
};


        // CONFIGURACI√ìN Y ESTADO
        const DB = {
            MO: ["Mantenimiento Preventivo", "Cambio Palma Amarga", "Inmunizaci√≥n Estructural", "Barnizado Marino", "Instalaci√≥n de Malla", "Construcci√≥n de Kiosco"],
            MAT: ["Palma Amarga (Bulto)", "Barniz Marino (Gal√≥n)", "Vara de Corozo", "Clavo Galvanizado", "Inmunizante", "Madera Estructural"]
        };
        let FOTOS_DB = [];
        let chartInstance = null;

        // NAVEGACI√ìN
        function nav(id, btn) {
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById('sec-' + id).classList.add('active-section');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if(id === 'pdf') updateChart();
            lucide.createIcons();
        }

        function toggleAnticipo() {
            const isChecked = document.getElementById('chk_anticipo').checked;
            document.getElementById('panel_anticipo').classList.toggle('hidden', !isChecked);
            calcular();
        }

        // GESTI√ìN DE ITEMS

function toggleFacturaField() {

    const tipo = document.getElementById('c_tipo').value;
    const contenedorFactura = document.getElementById('contenedor-num-factura');
    const labelTiempo = document.getElementById('label-tiempo');
    const inputTiempo = document.getElementById('c_garantia');
    const anticipoSection = document.getElementById('anticipoSection');

    if (tipo === 'FACTURA') {

        // Mostrar n√∫mero factura
        contenedorFactura.classList.remove('hidden');

        // Cambiar Garant√≠a ‚Üí Vencimiento
        labelTiempo.innerText = "Vencimiento (D√≠as)";
        labelTiempo.classList.replace('text-olive', 'text-red-500');

        if (inputTiempo.value == "0") inputTiempo.value = "8";

        // ‚úÖ OCULTAR ANTICIPO
        anticipoSection.classList.add('hidden');

    } else {

        // Ocultar n√∫mero factura
        contenedorFactura.classList.add('hidden');

        // Volver a Garant√≠a
        labelTiempo.innerText = "Garant√≠a (D√≠as)";
        labelTiempo.classList.replace('text-red-500', 'text-olive');

        document.getElementById('c_num_factura').value = '';

        // ‚úÖ MOSTRAR ANTICIPO
        anticipoSection.classList.remove('hidden');
    }
}


        function addItem(tipo) {
    const cont = tipo === 'MO' ? document.getElementById('cont-mo') : document.getElementById('cont-mat');
    const lista = tipo === 'MO' ? DB.MO : DB.MAT;
    const card = document.createElement('div');
    
    // A√±adimos clases de Tailwind para separaci√≥n: mb-6 (margen inferior)
    card.className = "glass-card p-6 relative border-l-8 mb-6 " + (tipo === 'MO' ? 'border-olive' : 'border-slate-800');
    
    card.innerHTML = `
        <button onclick="this.parentElement.remove(); calcular()" class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-2 shadow-lg z-10">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
        <div class="space-y-5"> <div>
                <label class="text-[9px] font-black text-slate-400 block ml-2 mb-1 uppercase">Descripci√≥n</label>
                <select class="item-sel font-black w-full text-sm" onchange="checkOther(this)">
                    <option value="">-- Seleccionar --</option>
                    ${lista.map(i => `<option value="${i}">${i}</option>`).join('')}
                    <option value="OTRO">‚úèÔ∏è OTRO / PERSONALIZADO</option>
                </select>
                <textarea class="item-custom hidden w-full h-20 p-4 mt-2 text-sm font-medium bg-slate-50 border-none rounded-2xl" placeholder="Escribe el detalle aqu√≠..."></textarea>
            </div>
            
            <div class="flex gap-4">
                <div class="w-1/3">
                    <label class="text-[9px] font-black text-slate-400 block ml-2 mb-1">CANT.</label>
                    <input type="number" value="1" class="item-q text-center font-bold !p-3 bg-slate-50 border-none">
                </div>
                <div class="w-2/3">
                    <label class="text-[9px] font-black text-slate-400 block ml-2 mb-1">VALOR UNITARIO</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-olive">$</span>
                        <input type="number" class="item-p font-bold !pl-10 bg-slate-50 border-none" oninput="calcular()" placeholder="0">
                    </div>
                </div>
            </div>
        </div>
    `;
    cont.appendChild(card);
    lucide.createIcons();
    calcular();
}

        function checkOther(sel) { 
            const area = sel.parentElement.querySelector('.item-custom');
            area.classList.toggle('hidden', sel.value !== 'OTRO');
        }

        function handlePhotos(input) {
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        FOTOS_DB.push({ src: e.target.result, desc: "" }); 
                        renderPhotos(); 
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function renderPhotos() {
            const cont = document.getElementById('cont-fotos');
            cont.innerHTML = '';
            FOTOS_DB.forEach((f, idx) => {
                const div = document.createElement('div');
                div.className = "photo-frame bg-white p-2";
                div.innerHTML = `
                    <img src="${f.src}" class="w-full h-56 object-cover rounded-2xl mb-4 shadow-inner">
                    <div class="p-2 space-y-3">
                        <textarea placeholder="Nota sobre esta foto..." class="w-full h-24 text-xs font-semibold bg-slate-50 border-none" 
                                  oninput="FOTOS_DB[${idx}].desc = this.value">${f.desc}</textarea>
                        <button onclick="FOTOS_DB.splice(${idx},1); renderPhotos()" class="text-red-500 font-black text-[10px] uppercase tracking-tighter flex items-center gap-1">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> Quitar imagen
                        </button>
                    </div>
                `;
                cont.appendChild(div);
            });
            lucide.createIcons();
        }

        function calcular() {
            let tMO = 0, tMAT = 0;
            document.querySelectorAll('#cont-mo > div').forEach(c => {
                tMO += (c.querySelector('.item-q').value * c.querySelector('.item-p').value);
            });
            document.querySelectorAll('#cont-mat > div').forEach(c => {
                tMAT += (c.querySelector('.item-q').value * c.querySelector('.item-p').value);
            });

            document.getElementById('sub_mo').innerText = `$ ${tMO.toLocaleString()}`;
            document.getElementById('sub_mat').innerText = `$ ${tMAT.toLocaleString()}`;
            
            const total = tMO + tMAT;
            document.getElementById('topTotal').innerText = `$ ${total.toLocaleString()}`;
            document.getElementById('finalTotal').innerText = `$ ${total.toLocaleString()}`;

            // Actualizar Anticipo
            if(document.getElementById('chk_anticipo').checked) {
                const pct = document.getElementById('val_anticipo_pct').value;
                const monto = (total * pct) / 100;
                document.getElementById('monto_anticipo_final').innerText = `$ ${monto.toLocaleString()}`;
            }
        }

        function updateChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            const mo = parseFloat(document.getElementById('sub_mo').innerText.replace(/[^0-9]/g, '')) || 0;
            const mat = parseFloat(document.getElementById('sub_mat').innerText.replace(/[^0-9]/g, '')) || 0;

            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mano de Obra', 'Materiales'],
                    datasets: [{
                        data: [mo, mat],
                        backgroundColor: ['#556B2F', '#1e293b'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold' } } } }
                }
            });

            const pMO = ((mo / (mo + mat)) * 100).toFixed(0);
            document.getElementById('statsSummary').innerText = `Servicios representan el ${pMO}% de la inversi√≥n`;
        }

       // GENERACI√ìN DE PDF PROFESIONAL


async function generarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const colorOlive = [40, 54, 24];
    const colorSlate = [30, 41, 59];

    // 1. Cabecera (Franja Verde)
doc.setFillColor(...colorOlive);
doc.rect(0, 0, 210, 45, 'F');

// 2. Insertar Logo (Si existe)
if (LOGO_BASE64) {
    doc.addImage(LOGO_BASE64, 'PNG', 15, 7, 30, 30); 
}

// 3. Texto del Encabezado
doc.setTextColor(255);
doc.setFontSize(22); 
doc.setFont(undefined, 'bold');
doc.text("KIOSCOS JOS√â ARTETA", 55, 25); // Posici√≥n X en 55 para dar espacio al logo

doc.setFontSize(10); 
doc.setFont(undefined, 'normal');
doc.text("ARQUITECTURA NATURAL & CONSTRUCCI√ìN T√âCNICA", 55, 32);
doc.text("WhatsApp: +57 300 601 4846 | josealcides2021arteta@gmail.com", 55, 38);

// 4. Tipo de Documento y Fecha (A la derecha)
doc.setFontSize(16); 
doc.setFont(undefined, 'bold');
doc.text(document.getElementById('c_tipo').value, 195, 25, {align: 'right'});
doc.setFontSize(8); 
doc.text(`FECHA: ${new Date().toLocaleDateString()}`, 195, 32, {align: 'right'});

            // 2. Info Cliente
            doc.setTextColor(...colorSlate);
            doc.setFontSize(10); doc.text("CLIENTE:", 20, 60);
            doc.setFontSize(12); doc.text(document.getElementById('c_nombre').value.toUpperCase(), 20, 67);
            doc.setFontSize(9); doc.setFont(undefined, 'normal');
            doc.text(`Ubicaci√≥n: ${document.getElementById('c_obra').value}`, 20, 73);
            doc.text(`Contacto: ${document.getElementById('c_tel').value} | ${document.getElementById('c_email').value}`, 20, 78);

            let currentY = 85;

            // 3. Tablas de Costos
            const getData = (id) => {
                let data = [];
                document.querySelectorAll(`#${id} > div`).forEach(c => {
                    let desc = c.querySelector('.item-sel').value;
                    if(desc === 'OTRO') desc = c.querySelector('.item-custom').value;
                    const q = c.querySelector('.item-q').value;
                    const p = c.querySelector('.item-p').value;
                    if(desc) data.push([q, desc.toUpperCase(), `$ ${parseFloat(p).toLocaleString()}`, `$ ${(q*p).toLocaleString()}`]);
                });
                return data;
            };

          // --- TABLA DE MANO DE OBRA ---
            const moData = getData('cont-mo');
            if(moData.length > 0) {
                // CALCULAR Y AGREGAR FILA DE SUBTOTAL
                const totalMO = moData.reduce((acc, row) => acc + (parseFloat(row[3].replace(/[^0-9.-]+/g,"")) || 0), 0);
                moData.push([{ content: 'SUBTOTAL SERVICIOS:', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } }, 
                             { content: `$ ${totalMO.toLocaleString()}`, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } }]);

                doc.autoTable({
                    startY: currentY,
                    head: [['Cant', 'Servicio T√©cnico / Descripci√≥n', 'Unitario', 'Subtotal']],
                    body: moData,
                    headStyles: { fillColor: colorOlive, fontSize: 10, cellPadding: 4 },
                    styles: { fontSize: 9, cellPadding: 3 },
                    columnStyles: { 0: {halign:'center'}, 3: {halign:'right', fontStyle:'bold'} }
                });
                currentY = doc.lastAutoTable.finalY + 10;
            }

            // --- TABLA DE MATERIALES ---
            const matData = getData('cont-mat');
            if(matData.length > 0) {
                // CALCULAR Y AGREGAR FILA DE SUBTOTAL
                const totalMat = matData.reduce((acc, row) => acc + (parseFloat(row[3].replace(/[^0-9.-]+/g,"")) || 0), 0);
                matData.push([{ content: 'SUBTOTAL MATERIALES:', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } }, 
                              { content: `$ ${totalMat.toLocaleString()}`, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } }]);

                doc.autoTable({
                    startY: currentY,
                    head: [['Cant', 'Materiales e Insumos', 'Unitario', 'Subtotal']],
                    body: matData,
                    headStyles: { fillColor: colorSlate, fontSize: 10 },
                    styles: { fontSize: 9 },
                    columnStyles: { 0: {halign:'center'}, 3: {halign:'right', fontStyle:'bold'} }
                });
                currentY = doc.lastAutoTable.finalY + 10;
            }

            // 4. Totales y Gr√°fica en PDF
           if (currentY > 220) { doc.addPage(); currentY = 20; }
            
            // CONFIGURACI√ìN DEL CUADRO
            doc.setFillColor(245, 247, 250); // Fondo claro
            doc.setDrawColor(...colorOlive);   // Color del borde (Verde)
            doc.setLineWidth(0.5);             // Grosor del borde
            
            // DIBUJAR RECUADRO REDONDEADO
            // (x, y, ancho, alto, radioX, radioY, estilo)
            // 'FD' significa Fill (Relleno) y Draw (Borde)
         doc.setFillColor(245, 247, 250); 
doc.setDrawColor(...colorOlive); 
doc.setLineWidth(0.5);
doc.roundedRect(145, currentY, 50, 18, 3, 3, 'FD');

            // TEXTOS
            doc.setTextColor(...colorSlate);
            doc.setFontSize(8); 
            doc.setFont(undefined, 'bold');
            doc.text("TOTAL:", 148, currentY + 6);
            
            doc.setFontSize(12);
            doc.text(document.getElementById('finalTotal').innerText, 191, currentY + 13, {align:'right'});

            // Anticipo
            if(document.getElementById('chk_anticipo').checked) {
                doc.setFontSize(8); doc.setTextColor(...colorOlive);
                doc.text(`Requiere anticipo de: ${document.getElementById('monto_anticipo_final').innerText}`, 130, currentY + 30);
            }

            currentY += 40;

            // 5. Firmas
            doc.setDrawColor(200);
            doc.line(20, currentY + 20, 85, currentY + 20);
            doc.line(125, currentY + 20, 190, currentY + 20);
            doc.setFontSize(8); doc.setTextColor(100);
            doc.text("FIRMA CONTRATISTA", 20, currentY + 25);
            doc.text("ACEPTACI√ìN CLIENTE", 125, currentY + 25);

            // 6. Anexo de Fotos (Dise√±o Cuadr√≠cula)
            if(FOTOS_DB.length > 0) {
                doc.addPage();
                doc.setTextColor(...colorOlive);
                doc.setFontSize(16); doc.text("ANEXO: EVIDENCIA FOTOGR√ÅFICA", 20, 25);
                
                let photoY = 40;
                FOTOS_DB.forEach((f, i) => {
                    if (photoY > 230) { doc.addPage(); photoY = 25; }
                    
                    // Marco de foto
                    doc.setDrawColor(230);
                    doc.rect(19, photoY - 1, 172, 52); 
                    
                    try {
                        doc.addImage(f.src, 'JPEG', 21, photoY, 65, 48);
                        doc.setTextColor(...colorSlate);
                        doc.setFontSize(10); doc.setFont(undefined, 'bold');
                        doc.text(`Registro #${i+1}:`, 90, photoY + 5);
                        doc.setFontSize(9); doc.setFont(undefined, 'normal');
                        doc.setTextColor(100);
                        const lines = doc.splitTextToSize(f.desc || "Evidencia t√©cnica del estado actual / proceso de obra.", 95);
                        doc.text(lines, 90, photoY + 12);
                    } catch(e) {}
                    
                    photoY += 60;
                });
            }

            // Pie de p√°gina con Iconos (Simulados con texto/color)
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(7);
                doc.setTextColor(150);
                doc.text("Kioscos Jose Arteta", 105, 290, {align:'center'});
            }

       const tipoDoc = document.getElementById('c_tipo').value;
const cliente = document.getElementById('c_nombre').value.replace(/\s+/g, '_');
const numFactura = document.getElementById('c_num_factura').value;
const fecha = new Date().toISOString().slice(0,10);

let nombreArchivo;

if(tipoDoc === "FACTURA" && numFactura){
    nombreArchivo = `FACTURA_${numFactura}_${cliente}.pdf`;
}else{
    nombreArchivo = `${tipoDoc}_${cliente}_${fecha}.pdf`;
}

doc.save(nombreArchivo);
}

        // Inicializaci√≥n
        lucide.createIcons();
        calcular();

toggleFacturaField();

// ... (tus funciones anteriores se mantienen igual)

 function obtenerDatosResumen() {
    // Usamos iti.getNumber() para que WhatsApp reciba el +57 correctamente
    const numeroCompleto = typeof iti !== 'undefined' ? iti.getNumber() : document.getElementById('c_tel').value;
    const tipoDoc = document.getElementById('c_tipo').value;
    const numFact = document.getElementById('c_num_factura').value;

    return {
        cliente: document.getElementById('c_nombre').value || "Cliente",
        telefono: numeroCompleto.replace('+', ''), // WhatsApp prefiere sin el +
        email: document.getElementById('c_email').value,
        total: document.getElementById('finalTotal').innerText,
        tipo: tipoDoc,
        // Si hay n√∫mero de factura, crea: "FACTURA N¬∞ 001", si no, solo "COTIZACI√ìN"
        tipoEtiqueta: numFact ? `${tipoDoc} N¬∞ ${numFact}` : tipoDoc,
        obra: document.getElementById('c_obra').value || "No especificada"
    };
}
   
/*
    function enviarWhatsApp() {
        const d = obtenerDatosResumen();
        if(!d.telefono) {
            alert("Por favor, ingrese un n√∫mero de tel√©fono en la secci√≥n de Identificaci√≥n.");
            nav('cliente', document.querySelector('[onclick*="cliente"]'));
            return;
        }

        const mensaje = encodeURIComponent(
            `*PROYECTO: ${d.tipo}*\n` +
            `---------------------------\n` +
            `Hola, *${d.cliente}*.\n` +
            `Adjunto el resumen de la propuesta para la obra en: *${d.obra}*.\n\n` +
            `üí∞ *Inversi√≥n Total:* ${d.total}\n` +
            `üõ†Ô∏è _Kioscos Jos√© Arteta - Arquitectura Natural_`
        );

        window.open(`https://wa.me/${d.telefono}?text=${mensaje}`, '_blank');
    }

    */
 function enviarWhatsApp() {
    // 1. Obtenemos los datos base (Nombre, Tel√©fono, Obra)
    const d = obtenerDatosResumen();

    if(!d.telefono) {
        alert("Por favor, ingrese un n√∫mero de tel√©fono en la secci√≥n de Identificaci√≥n.");
        nav('cliente', document.querySelector('[onclick*="cliente"]'));
        return;
    }

    // 2. Obtenemos los subtotales usando los IDs reales de tu HTML
    const totalMat = document.getElementById('sub_mat').innerText;
    const totalServ = document.getElementById('sub_mo').innerText;

    // 3. Construimos el mensaje con saltos de l√≠nea limpios (\n\n)
    const textoMensaje = 
        `Hola, *${d.cliente}*.\n\n` +
        `Es un gusto saludarte. Adjunto el resumen de tu *${d.tipo}* para la obra en: *${d.obra}*.\n\n` +
        `‚Ä¢ *Total Materiales:* ${totalMat}\n` +
        `‚Ä¢ *Total Servicios:* ${totalServ}\n` +
        `*INVERSI√ìN TOTAL:* ${d.total}\n\n` +
        `*Nota:* El documento detallado en PDF ha sido generado y se le enviar√° a la brevedad por este medio.\n\n` +
        `_Quedo atento a cualquier duda adicional._\n\n` +
        `---------------------------\n` +
        `*KIOSCOS JOS√â ARTETA*\n` +
        `_Arquitectura Natural_`;

    // 4. Codificamos y abrimos la ventana
    const mensajeFinal = encodeURIComponent(textoMensaje);
    window.open(`https://wa.me/${d.telefono}?text=${mensajeFinal}`, '_blank');
}

    function enviarEmail() {
        const d = obtenerDatosResumen();
        if(!d.email) {
            alert("Por favor, ingrese un correo electr√≥nico en la secci√≥n de Identificaci√≥n.");
            nav('cliente', document.querySelector('[onclick*="cliente"]'));
            return;
        }

        const asunto = encodeURIComponent(`${d.tipo} - Kioscos Jos√© Arteta`);
        const cuerpo = encodeURIComponent(
            `Estimado(a) ${d.cliente},\n\n` +
            `Es un gusto saludarle. A continuaci√≥n presento el resumen del presupuesto para su proyecto:\n\n` +
            `Ubicaci√≥n: ${d.obra}\n` +
            `Valor Total: ${d.total}\n\n` +
            `Quedo atento a cualquier inquietud para proceder con la programaci√≥n de la obra.\n\n` +
            `Atentamente,\n` +
            `Jos√© Arteta\n` +
            `Arquitectura Natural & Construcci√≥n T√©cnica`
        );

        window.location.href = `mailto:${d.email}?subject=${asunto}&body=${cuerpo}`;
    }
// Inicializaci√≥n del selector de pa√≠ses
const inputTel = document.querySelector("#c_tel");
const iti = window.intlTelInput(inputTel, {
    initialCountry: "co", // Colombia por defecto
    separateDialCode: true, // Muestra el +57 fuera del cuadro de texto
    utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@21.2.7/build/js/utils.js",
});

// MODIFICACI√ìN NECESARIA EN LA FUNCI√ìN obtenerDatosResumen
// Para que WhatsApp tome el c√≥digo del pa√≠s correctamente
function obtenerDatosResumen() {
    const numeroCompleto = iti.getNumber(); // Esto obtiene el +57 junto al n√∫mero
    return {
        cliente: document.getElementById('c_nombre').value || "Cliente",
        telefono: numeroCompleto.replace('+', ''), // WhatsApp prefiere sin el +
        email: document.getElementById('c_email').value,
        total: document.getElementById('finalTotal').innerText,
        tipo: document.getElementById('c_tipo').value,
        obra: document.getElementById('c_obra').value || "No especificada"
    };
}





    </script>
</body>
</html>